name: Deploy Preview on tag

on:
  push:
    tags:
      - "preview/*"

permissions:
  contents: read

concurrency:
  group: deploy-preview-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    environment: preview
    runs-on: [self-hosted, ubuntu-salafi-durus-preview-app]

    env:
      # repo-level variables (Settings → Variables)
      DEPLOY_DIR: ${{ vars.DEPLOY_DIR }}

      # environment-level variables (Settings → Environments → preview → Variables)
      NODE_ENV: ${{ vars.NODE_ENV }}
      NEST_PORT: ${{ vars.NEST_PORT }}
      HOST_API_PORT: ${{ vars.HOST_API_PORT }}
      DB_USER: ${{ vars.DB_USER }}
      DB_NAME: ${{ vars.DB_NAME }}

      # environment-level secrets (Settings → Environments → preview → Secrets)
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
      R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      R2_BUCKET: ${{ secrets.R2_BUCKET }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Ensure deploy folder exists
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${DEPLOY_DIR}"
          mkdir -p "${DEPLOY_DIR}/infra/envs"
          chmod 700 "${DEPLOY_DIR}/infra/envs"

      - name: Sync repo into DEPLOY_DIR (local)
        shell: bash
        run: |
          set -euo pipefail
          rsync -az --delete \
            --exclude='.git' \
            --exclude='node_modules' \
            ./ "${DEPLOY_DIR}/code/"

      - name: Write preview env file (server-local)
        shell: bash
        run: |
          set -euo pipefail
          cat > "${DEPLOY_DIR}/infra/envs/.env.preview" <<EOF
          NODE_ENV=${NODE_ENV}
          PORT=${NEST_PORT}
          HOST_API_PORT=${HOST_API_PORT}

          # Preview DB inside docker network (postgres_preview service)
          DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@postgres_preview:5432/${DB_NAME}

          DB_USER=${DB_USER}
          DB_NAME=${DB_NAME}
          DB_HOST=postgres_preview
          DB_PORT=5432
          DB_PASSWORD=${DB_PASSWORD}

          JWT_SECRET=${JWT_SECRET}

          R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
          R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
          R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
          R2_BUCKET=${R2_BUCKET}
          EOF
          chmod 600 "${DEPLOY_DIR}/infra/envs/.env.preview"

      - name: Deploy preview containers
        shell: bash
        run: |
          set -euo pipefail
          cd "${DEPLOY_DIR}/code/infra"
          ./scripts/deploy.sh

      - name: Run preview migrations
        shell: bash
        run: |
          set -euo pipefail
          cd "${DEPLOY_DIR}/code/infra"
          ./scripts/migrate_preview.sh
