name: Run dev migrations (manual)

on:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: migrate-dev-${{ github.ref }}
  cancel-in-progress: true

jobs:
  migrate-dev:
    environment: development
    runs-on: ubuntu-latest
    env:
      DEPLOY_DIR: ${{ vars.DEPLOY_DIR }}
      SERVER_USER: ${{ vars.SERVER_USER }}
      SERVER_HOST: ${{ vars.SERVER_HOST }}
      NEST_PORT: ${{ vars.NEST_PORT }}
      # environment-scoped variables (set these in Settings -> Environments -> development -> Variables)
      DEV_NODE_ENV: ${{ vars.NODE_ENV }}
      DEV_DB_USER: ${{ vars.DB_USER }}
      DEV_DB_NAME: ${{ vars.DB_NAME }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup ssh-agent
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Ensure rsync available
        run: sudo apt-get update && sudo apt-get install -y rsync

      - name: Create dev env file (locally on runner)
        run: |
          mkdir -p .deploy_tmp
          cat > .deploy_tmp/env.dev <<EOF
          NODE_ENV=${{ vars.NODE_ENV }}
          PORT=${{ vars.NEST_PORT }}
          HOST_API_PORT=${{ vars.HOST_API_PORT }}

          DATABASE_URL=postgresql://${{ vars.DB_USER }}:${{ secrets.DB_PASSWORD }}@localhost:5433/${{ vars.DB_NAME }}

          DB_USER=${{ vars.DB_USER }}
          DB_NAME=${{ vars.DB_NAME }}
          DB_HOST=localhost
          DB_PORT=5433
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}

          JWT_SECRET=${{ secrets.JWT_SECRET }}

          R2_ACCOUNT_ID=${{ secrets.R2_ACCOUNT_ID }}
          R2_ACCESS_KEY_ID=${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY=${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_BUCKET=${{ secrets.R2_BUCKET }}
          EOF
          echo "Dev env generated (secrets suppressed)"
          sed -n '1,8p' .deploy_tmp/env.dev

      - name: Rsync env file to server (secure)
        run: |
          ssh -o StrictHostKeyChecking=no "${{ vars.SERVER_USER }}@${{ vars.SERVER_HOST }}" "mkdir -p ${DEPLOY_DIR}/infra/envs && chmod 700 ${DEPLOY_DIR}/infra/envs"
          rsync -az --chmod=600 .deploy_tmp/env.dev "${{ vars.SERVER_USER }}@${{ vars.SERVER_HOST }}:${DEPLOY_DIR}/infra/envs/.env.dev"

      - name: Run dev migration script on server
        run: |
          ssh -o StrictHostKeyChecking=no "${{ vars.SERVER_USER }}@${{ vars.SERVER_HOST }}" bash -lc "cd ${DEPLOY_DIR}/infra && ./scripts/migrate_dev.sh"
